<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leaderboard</title>

<style>
/* ===========================
   GLOBAL
   =========================== */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
}

/* ===========================
   HEADER (UNCHANGED)
   =========================== */
header {
  background: #0f172a;
  color: #fff;
  padding: 20px;
  text-align: center;
}

nav a {
  color: #fff;
  margin: 0 12px;
  text-decoration: none;
  font-weight: bold;
}

/* ===========================
   CONTAINER
   =========================== */
.leaderboard-container {
  max-width: 900px;
  margin: 40px auto;
  padding: 0 20px;
}

.title {
  text-align: center;
  color: #0f172a;
  margin-bottom: 6px;
}

.subtitle, .updated {
  text-align: center;
  color: #64748b;
  margin-bottom: 20px;
}

/* ===========================
   SEARCH
   =========================== */
.search {
  width: 100%;
  padding: 14px;
  margin-bottom: 18px;
  border-radius: 12px;
  border: none;
  outline: none;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* ===========================
   TABLE (DESKTOP)
   =========================== */
.leaderboard {
  width: 100%;
  border-collapse: collapse;
  background: #0b1220;
  border-radius: 16px;
  overflow: hidden;
}

.leaderboard thead {
  background: #111827;
}

.leaderboard th {
  padding: 14px;
  text-align: left;
  color: #94a3b8;
  font-size: 14px;
}

.leaderboard td {
  padding: 14px;
  border-top: 1px solid #1f2937;
  color: #e5e7eb;
  font-size: 15px;
}

.leaderboard tr:hover {
  background: #111827;
}

.rank {
  font-weight: bold;
  width: 80px;
}

.rank.gold { color: #facc15; }
.rank.silver { color: #e5e7eb; }
.rank.bronze { color: #fb923c; }

.username a {
  color: #e5e7eb;
  text-decoration: none;
  font-weight: bold;
}

.username a:hover {
  text-decoration: underline;
}

.score {
  text-align: right;
  color: #22d3ee;
  font-weight: bold;
}

/* ===========================
   MOBILE VERSION
   =========================== */
@media (max-width: 640px) {

  .leaderboard thead {
    display: none;
  }

  .leaderboard,
  .leaderboard tbody,
  .leaderboard tr,
  .leaderboard td {
    display: block;
    width: 100%;
  }

  .leaderboard tr {
    background: #0b1220;
    margin-bottom: 14px;
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.25);
  }

  .leaderboard td {
    border: none;
    padding: 6px 0;
  }

  .rank {
    display: inline-flex;
    width: 34px;
    height: 34px;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: #1f2937;
    margin-right: 10px;
  }

  .rank.gold { background: #facc15; color: #000; }
  .rank.silver { background: #e5e7eb; color: #000; }
  .rank.bronze { background: #fb923c; color: #000; }

  .username {
    font-size: 16px;
  }

  .score {
    margin-top: 6px;
    font-size: 15px;
  }
}
</style>
</head>

<body>

<header>
  <h1>Engineer it!</h1>
  <nav>
    <a href="ranking.html">Leaderboard</a>
    <a href="students.html">Challenges</a>
    <a href="events.html">Events</a>
    <a href="competitions.html">Competitions</a>
  </nav>
</header>

<div class="leaderboard-container">
  <h2 class="title">üèÜ Student Scores Leaderboard</h2>
  <p class="subtitle">Top students of the Engineering Course</p>
  <p class="updated">Last updated: </p>
  <input
    type="text"
    id="search"
    class="search"
    placeholder="üîç Search student..."
  />

  <table class="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Username</th>
        <th style="text-align:right">Score</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>
</div>

<script>
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQs_aNF-dVdRJkBnX1wyyxKDQgIs7zAD3NY-XLkYuEhewKQNMZoaH_3sSojL0kQujYOmOmbDwdK11tn/pub?gid=0&single=true&output=csv";

let students = [];
const tbody = document.getElementById("leaderboard-body");
const searchInput = document.getElementById("search");
const updatedEl = document.querySelector('.updated');

function refreshUpdated() {
  fetch(SHEET_URL, { cache: 'no-cache' })
    .then(res => {
      if (!res.ok) throw new Error('Sheet not accessible');
      const lastMod = res.headers.get('Last-Modified');
      return res.text().then(csv => ({ csv, lastMod }));
    })
    .then(({ csv, lastMod }) => {
      const lines = csv.trim().split(/\r?\n/);
      const header = lines.shift().split(',');

      let updatedText = null;
      if (lastMod) {
        const d = new Date(lastMod);
        if (!isNaN(d)) updatedText = d.toLocaleString();
      }

      if (!updatedText) {
        const updatedIdx = header.findIndex(h => /updated/i.test((h||'').trim()));
        if (updatedIdx >= 0 && lines.length > 0) {
          const firstParts = lines[0].split(',');
          const raw = (firstParts[updatedIdx] || '').trim();
          if (raw) {
            const d2 = new Date(raw);
            updatedText = isNaN(d2) ? raw : d2.toLocaleString();
          }
        }
      }

      if (!updatedText) updatedText = new Date().toLocaleString();
      if (updatedEl) updatedEl.textContent = 'Last updated: ' + updatedText;
    })
    .catch(err => {
      console.error('Failed to refresh updated time', err);
    });
}

// Refresh immediately and then every 5 minutes
refreshUpdated();
setInterval(refreshUpdated, 5 * 60 * 1000);

fetch(SHEET_URL)
  .then(res => {
    if (!res.ok) throw new Error("Sheet not accessible");
    const lastMod = res.headers.get('Last-Modified');
    return res.text().then(csv => ({ csv, lastMod }));
  })
  .then(({ csv, lastMod }) => {
    const lines = csv.trim().split(/\r?\n/);
    const header = lines.shift().split(",");

    if (
      header[0]?.trim() !== "id" ||
      header[1]?.trim() !== "name" ||
      header[2]?.trim() !== "score"
    ) {
      throw new Error("CSV header mismatch");
    }

    // Determine updated time: prefer Last-Modified header, then an `updated` CSV column, else fallback to now
    let updatedText = null;
    if (lastMod) {
      const d = new Date(lastMod);
      if (!isNaN(d)) updatedText = d.toLocaleString();
    }

    if (!updatedText) {
      const updatedIdx = header.findIndex(h => /updated/i.test((h||"").trim()));
      if (updatedIdx >= 0 && lines.length > 0) {
        const firstParts = lines[0].split(",");
        const raw = (firstParts[updatedIdx] || "").trim();
        if (raw) {
          const d2 = new Date(raw);
          updatedText = isNaN(d2) ? raw : d2.toLocaleString();
        }
      }
    }

    if (!updatedText) updatedText = new Date().toLocaleString();
    if (updatedEl) updatedEl.textContent = 'Last updated: ' + updatedText;

    students = lines.map(line => {
      const parts = line.split(",");
      return {
        id: parts[0].trim(),
        name: parts[1].trim(),
        score: Number(parts[2].trim()) || 0
      };
    });

    render(students);
  })
  .catch(err => {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" style="color:red; text-align:center; padding:20px;">
          ‚ö† Failed to load leaderboard data
        </td>
      </tr>
    `;
    console.error(err);
  });

function render(data) {
  tbody.innerHTML = "";

  data
    .sort((a, b) => b.score - a.score)
    .forEach((s, index) => {
      let rankClass = "";
      if (index === 0) rankClass = "gold";
      else if (index === 1) rankClass = "silver";
      else if (index === 2) rankClass = "bronze";

      tbody.innerHTML += `
        <tr>
          <td class="rank ${rankClass}">#${index + 1}</td>
          <td class="username">
            <a href="profile.html?id=${s.id}">
              ${s.name}
            </a>
          </td>
          <td class="score">${s.score} pts</td>
        </tr>
      `;
    });
}

searchInput.addEventListener("input", e => {
  const value = e.target.value.toLowerCase().trim();
  render(
    students.filter(s =>
      s.name.toLowerCase().includes(value)
    )
  );
});
</script>


</body>
</html>
